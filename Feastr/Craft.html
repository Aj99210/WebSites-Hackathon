<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fester - Craft Perfect Recipes</title>
    <link rel="stylesheet" href="Craft_Style.css">
</head>
<body>
    <!-- Floating Background Elements -->
    <div class="floating-element element-1"></div>
    <div class="floating-element element-2"></div>
    <div class="floating-element element-3"></div>

    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="logo">Fester</div>
            <a href="Landing.html" class="home-icon">üè†</a>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <div class="crafting-container">
            <!-- Input Section -->
            <div class="input-section">
                <div class="feature-badge">‚ú® AI-Powered</div>
                <h1 class="section-title">Craft Your Perfect Recipe</h1>
                
                <div class="input-group">
                    <label for="recipeInput">Describe your dish or ingredients:</label>
                    <textarea 
                        id="recipeInput" 
                        class="recipe-input" 
                        placeholder="e.g., Spicy pasta with garlic and herbs, or just list your ingredients: pasta, garlic, tomatoes..."
                        rows="5"
                    ></textarea>
                </div>

                <button id="craftBtn" class="craft-btn">
                    <span class="btn-text">Craft Recipe</span>
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Crafting...</span>
                    </div>
                </button>
            </div>

            <!-- Result Section -->
            <div class="result-section">
                <div class="feature-badge">üéØ Professional Grade</div>
                <h2 class="section-title">Your Crafted Recipe</h2>
                
                <div id="placeholder" class="placeholder">
                    <span class="placeholder-icon">üë®‚Äçüç≥</span>
                    <p>Enter your ingredients or dish idea, and watch AI magic create a perfect recipe with detailed instructions, nutritional info, and chef-level techniques!</p>
                </div>

                <div id="recipeOutput" class="recipe-output">
                    <h3 id="recipeTitle" class="recipe-title"></h3>
                    <div id="recipeContent" class="recipe-content"></div>
                    
                    <!-- Enhanced Button Container -->
                    <div style="display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap;">
                        <button id="copyBtn" class="copy-btn">üìã Copy Recipe</button>
                        <button id="ttsBtn" class="copy-btn" style="background: rgba(52, 152, 219, 0.1); border-color: rgba(52, 152, 219, 0.3); color: #3498db;">
                            üîä Read Recipe
                        </button>
                        <button id="stopTtsBtn" class="copy-btn" style="background: rgba(231, 76, 60, 0.1); border-color: rgba(231, 76, 60, 0.3); color: #e74c3c; display: none;">
                            ‚èπÔ∏è Stop Reading
                        </button>
                    </div>
                    
                    <!-- TTS Controls -->
                    <div id="ttsControls" style="margin-top: 1.5rem; padding: 1.5rem; background: rgba(255, 255, 255, 0.1); border-radius: 12px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); display: none;">
                        <h4 style="margin-bottom: 1rem; color: var(--primary-brown);">üéôÔ∏è Voice Controls</h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--dark-brown);">Voice:</label>
                                <select id="voiceSelect" style="width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid rgba(139, 90, 60, 0.3); background: rgba(255, 255, 255, 0.9);">
                                    <option value="">Default Voice</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--dark-brown);">Speed:</label>
                                <select id="speedSelect" style="width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid rgba(139, 90, 60, 0.3); background: rgba(255, 255, 255, 0.9);">
                                    <option value="0.5">0.5x (Slow)</option>
                                    <option value="0.75">0.75x</option>
                                    <option value="1" selected>1x (Normal)</option>
                                    <option value="1.25">1.25x</option>
                                    <option value="1.5">1.5x (Fast)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button id="readTitleBtn" class="copy-btn" style="font-size: 0.9rem; padding: 0.5rem 1rem; background: rgba(46, 204, 113, 0.1); border-color: rgba(46, 204, 113, 0.3); color: #2ecc71;">
                                üìù Title Only
                            </button>
                            <button id="readIngredientsBtn" class="copy-btn" style="font-size: 0.9rem; padding: 0.5rem 1rem; background: rgba(155, 89, 182, 0.1); border-color: rgba(155, 89, 182, 0.3); color: #9b59b6;">
                                ü•ï Ingredients
                            </button>
                            <button id="readInstructionsBtn" class="copy-btn" style="font-size: 0.9rem; padding: 0.5rem 1rem; background: rgba(230, 126, 34, 0.1); border-color: rgba(230, 126, 34, 0.3); color: #e67e22;">
                                üë®‚Äçüç≥ Instructions
                            </button>
                        </div>
                    </div>
                </div>

                <div id="errorMessage" class="error-message" style="display: none;"></div>
            </div>
        </div>
    </main>

    <script>
        // API Configuration
        const API_KEY = 'AIzaSyAylB7P7m14nZPrRuxEGB_Q9y9ccC5Fbls'; 
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent';

        // DOM Elements
        const recipeInput = document.getElementById('recipeInput');
        const craftBtn = document.getElementById('craftBtn');
        const btnText = document.querySelector('.btn-text');
        const loading = document.querySelector('.loading');
        const placeholder = document.getElementById('placeholder');
        const recipeOutput = document.getElementById('recipeOutput');
        const recipeTitle = document.getElementById('recipeTitle');
        const recipeContent = document.getElementById('recipeContent');
        const copyBtn = document.getElementById('copyBtn');
        const errorMessage = document.getElementById('errorMessage');

        // TTS Elements
        const ttsBtn = document.getElementById('ttsBtn');
        const stopTtsBtn = document.getElementById('stopTtsBtn');
        const ttsControls = document.getElementById('ttsControls');
        const voiceSelect = document.getElementById('voiceSelect');
        const speedSelect = document.getElementById('speedSelect');
        const readTitleBtn = document.getElementById('readTitleBtn');
        const readIngredientsBtn = document.getElementById('readIngredientsBtn');
        const readInstructionsBtn = document.getElementById('readInstructionsBtn');

        // TTS Variables
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let availableVoices = [];
        let currentRecipeData = null;

        // Initialize TTS
        function initializeTTS() {
            if ('speechSynthesis' in window) {
                loadVoices();
                speechSynthesis.onvoiceschanged = loadVoices;
            } else {
                ttsBtn.style.display = 'none';
                console.log('Speech synthesis not supported');
            }
        }

        // Load Available Voices
        function loadVoices() {
            availableVoices = speechSynthesis.getVoices();
            voiceSelect.innerHTML = '<option value="">Default Voice</option>';
            
            availableVoices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${voice.name} (${voice.lang})`;
                
                // Prefer English voices
                if (voice.lang.startsWith('en')) {
                    option.textContent += ' ‚≠ê';
                }
                
                voiceSelect.appendChild(option);
            });
        }

        // Enhanced Text-to-Speech Function
        function speakText(text, options = {}) {
            if (currentUtterance) {
                speechSynthesis.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(text);
            
            // Set voice
            const selectedVoiceIndex = voiceSelect.value;
            if (selectedVoiceIndex && availableVoices[selectedVoiceIndex]) {
                utterance.voice = availableVoices[selectedVoiceIndex];
            }
            
            // Set speed
            utterance.rate = parseFloat(speedSelect.value);
            
            // Set other properties
            utterance.pitch = options.pitch || 1;
            utterance.volume = options.volume || 1;
            
            // Event listeners
            utterance.onstart = () => {
                ttsBtn.style.display = 'none';
                stopTtsBtn.style.display = 'inline-flex';
                updateTTSButtonText('üîä Speaking...');
            };
            
            utterance.onend = () => {
                ttsBtn.style.display = 'inline-flex';
                stopTtsBtn.style.display = 'none';
                updateTTSButtonText('üîä Read Recipe');
                currentUtterance = null;
            };
            
            utterance.onerror = (event) => {
                console.error('Speech synthesis error:', event.error);
                showError('Error with text-to-speech: ' + event.error);
                ttsBtn.style.display = 'inline-flex';
                stopTtsBtn.style.display = 'none';
                updateTTSButtonText('üîä Read Recipe');
                currentUtterance = null;
            };
            
            currentUtterance = utterance;
            speechSynthesis.speak(utterance);
        }

        // Update TTS Button Text
        function updateTTSButtonText(text) {
            const buttons = [ttsBtn, stopTtsBtn];
            buttons.forEach(btn => {
                if (btn && btn.style.display !== 'none') {
                    btn.innerHTML = text;
                }
            });
        }

        // Clean Text for TTS
        function cleanTextForTTS(text) {
            return text
                .replace(/<[^>]*>/g, '') // Remove HTML tags
                .replace(/\*\*/g, '') // Remove markdown bold
                .replace(/\*/g, '') // Remove markdown italic
                .replace(/#{1,6}\s/g, '') // Remove markdown headers
                .replace(/\n\s*\n/g, '. ') // Replace double newlines with periods
                .replace(/\n/g, ' ') // Replace single newlines with spaces
                .replace(/\s+/g, ' ') // Replace multiple spaces with single space
                .replace(/(\d+)\./g, '$1.') // Ensure numbers are read properly
                .trim();
        }

        // Parse Recipe Sections
        function parseRecipeForTTS(recipeText) {
            const sections = {
                title: '',
                ingredients: '',
                instructions: '',
                full: ''
            };

            const lines = recipeText.split('\n');
            let currentSection = '';
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                // Detect sections
                if (line.toLowerCase().includes('ingredient')) {
                    currentSection = 'ingredients';
                    continue;
                } else if (line.toLowerCase().includes('instruction') || line.toLowerCase().includes('method') || line.toLowerCase().includes('step')) {
                    currentSection = 'instructions';
                    continue;
                } else if (line.match(/^#+\s*(.*)$/)) {
                    // This is a header
                    const headerText = line.replace(/^#+\s*/, '');
                    if (!sections.title) {
                        sections.title = headerText;
                    }
                    continue;
                }

                // Add to appropriate section
                if (currentSection === 'ingredients') {
                    sections.ingredients += line + '\n';
                } else if (currentSection === 'instructions') {
                    sections.instructions += line + '\n';
                } else {
                    sections.full += line + '\n';
                }
            }

            // If no specific sections found, use full text
            if (!sections.ingredients && !sections.instructions) {
                sections.full = recipeText;
            }

            return sections;
        }

        // Event Listeners
        craftBtn.addEventListener('click', generateRecipe);
        copyBtn.addEventListener('click', copyRecipe);
        recipeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                generateRecipe();
            }
        });

        // TTS Event Listeners
        ttsBtn.addEventListener('click', () => {
            if (currentRecipeData) {
                const fullText = `${currentRecipeData.title}. ${cleanTextForTTS(currentRecipeData.full)}`;
                speakText(fullText);
                ttsControls.style.display = 'block';
            }
        });

        stopTtsBtn.addEventListener('click', () => {
            if (currentUtterance) {
                speechSynthesis.cancel();
                currentUtterance = null;
                ttsBtn.style.display = 'inline-flex';
                stopTtsBtn.style.display = 'none';
                updateTTSButtonText('üîä Read Recipe');
            }
        });

        readTitleBtn.addEventListener('click', () => {
            if (currentRecipeData && currentRecipeData.title) {
                speakText(currentRecipeData.title);
            }
        });

        readIngredientsBtn.addEventListener('click', () => {
            if (currentRecipeData && currentRecipeData.ingredients) {
                const text = `Ingredients: ${cleanTextForTTS(currentRecipeData.ingredients)}`;
                speakText(text);
            } else {
                showError('No ingredients section found');
            }
        });

        readInstructionsBtn.addEventListener('click', () => {
            if (currentRecipeData && currentRecipeData.instructions) {
                const text = `Instructions: ${cleanTextForTTS(currentRecipeData.instructions)}`;
                speakText(text);
            } else {
                showError('No instructions section found');
            }
        });

        // Generate Recipe Function
        async function generateRecipe() {
            const userInput = recipeInput.value.trim();
            
            if (!userInput) {
                showError('Please enter some ingredients or describe your dish!');
                return;
            }

            // Show loading state
            craftBtn.disabled = true;
            btnText.style.display = 'none';
            loading.style.display = 'flex';
            hideError();

            try {
                const prompt = `Create a detailed, professional recipe based on: "${userInput}". 

                Please provide:
                1. Recipe name
                2. Ingredients list with precise measurements
                3. Step-by-step cooking instructions
                4. Cooking time and serving size
                5. Nutritional highlights
                6. Chef tips or variations

                Format the response in a clear, organized way with proper headings and bullet points.`;

                const requestBody = {
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 8192,
                    }
                };

                console.log('Making API request to:', `${API_URL}?key=${API_KEY}`);
                console.log('Request body:', JSON.stringify(requestBody, null, 2));

                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers));

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('API Error Details:', errorData);
                    throw new Error(`API Error: ${response.status} - ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                console.log('API Response:', data);

                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Invalid response format from API');
                }

                const recipeText = data.candidates[0].content.parts[0].text;
                displayRecipe(recipeText);

            } catch (error) {
                console.error('Error generating recipe:', error);
                showError(`Sorry, there was an error generating your recipe: ${error.message}`);
            } finally {
                // Reset button state
                craftBtn.disabled = false;
                btnText.style.display = 'inline';
                loading.style.display = 'none';
            }
        }

        // Display Recipe Function
        function displayRecipe(recipeText) {
            // Hide placeholder
            placeholder.style.display = 'none';
            
            // Extract title from the first line or create one
            const lines = recipeText.split('\n');
            let title = 'Your Custom Recipe';
            
            // Try to find a title in the first few lines
            for (let i = 0; i < Math.min(3, lines.length); i++) {
                const line = lines[i].trim();
                if (line && !line.startsWith('*') && !line.startsWith('-') && !line.match(/^\d+\./)) {
                    title = line.replace(/^#+\s*/, '').replace(/\*\*/g, '').trim();
                    break;
                }
            }
            
            // Format the recipe content
            const formattedContent = formatRecipeContent(recipeText);
            
            // Parse recipe for TTS
            currentRecipeData = parseRecipeForTTS(recipeText);
            currentRecipeData.title = title;
            currentRecipeData.full = recipeText;
            
            // Update DOM
            recipeTitle.textContent = title;
            recipeContent.innerHTML = formattedContent;
            
            // Show recipe output
            recipeOutput.classList.add('show');
        }

        // Format Recipe Content
        function formatRecipeContent(text) {
            // Convert markdown-style formatting to HTML
            let formatted = text
                .replace(/^#+\s*(.*)$/gm, '<h3>$1</h3>')
                .replace(/^\*\s*(.*)$/gm, '<li>$1</li>')
                .replace(/^-\s*(.*)$/gm, '<li>$1</li>')
                .replace(/^\d+\.\s*(.*)$/gm, '<li>$1</li>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Wrap consecutive list items in ul tags
            formatted = formatted.replace(/(<li>.*?<\/li>(\s*<li>.*?<\/li>)*)/gs, '<ul>$1</ul>');
            
            // Add paragraph breaks for lines that aren't already formatted
            const lines = formatted.split('\n');
            let result = '';
            let inList = false;
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                if (line.includes('<ul>')) {
                    inList = true;
                    result += line + '\n';
                } else if (line.includes('</ul>')) {
                    inList = false;
                    result += line + '\n';
                } else if (line.includes('<h3>') || line.includes('<li>')) {
                    result += line + '\n';
                } else if (!inList && line.length > 0) {
                    result += `<p>${line}</p>\n`;
                }
            }

            return result;
        }

        // Copy Recipe Function
        function copyRecipe() {
            const title = recipeTitle.textContent;
            const content = recipeContent.innerText;
            const fullRecipe = `${title}\n\n${content}`;
            
            navigator.clipboard.writeText(fullRecipe).then(() => {
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy recipe:', err);
                showError('Failed to copy recipe to clipboard');
            });
        }

        // Error Handling
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            recipeInput.focus();
            initializeTTS();
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (currentUtterance) {
                speechSynthesis.cancel();
            }
        });
    </script>
</body>
</html>